<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€ç³–è¿½è¹¤è¨˜éŒ„ç³»çµ± | Glucose Tracker</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .timing-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .timing-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .timing-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .timing-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .records-list {
            margin-top: 20px;
        }

        .record-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 5px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .record-item.high {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .record-item.low {
            border-left-color: #f39c12;
            background: #fffbf0;
        }

        .record-item.normal {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .record-info {
            flex: 1;
        }

        .record-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .record-value .unit {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        .record-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .record-timing {
            display: inline-block;
            padding: 3px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
        }

        .record-actions {
            display: flex;
            gap: 8px;
        }

        .btn-delete {
            padding: 8px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .unit-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .unit-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .unit-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ç™»å…¥é é¢æ¨£å¼ */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .auth-form {
            margin-top: 20px;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            min-height: 20px;
        }

        .btn-logout {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .header {
            position: relative;
        }

        /* Modal æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        /* å ±è¡¨æ¨£å¼ */
        .report-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .report-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .report-stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .report-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 12px;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 8px;
        }

        .status-normal {
            background: #d4edda;
            color: #155724;
        }

        .status-high {
            background: #f8d7da;
            color: #721c24;
        }

        .status-low {
            background: #fff3cd;
            color: #856404;
        }

        .report-chart {
            margin-top: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-label {
            width: 100px;
            font-size: 13px;
            color: #666;
        }

        .chart-progress {
            flex: 1;
            height: 25px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .chart-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .chart-value {
            margin-left: 10px;
            font-weight: 600;
            font-size: 13px;
            min-width: 40px;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
            opacity: 0.9;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .timing-buttons {
                grid-template-columns: 1fr;
            }

            .login-container {
                padding: 30px 20px;
            }

            .btn-logout {
                top: 15px;
                right: 15px;
                padding: 8px 15px;
                font-size: 12px;
            }

            .report-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <h1>ğŸ©¸ è¡€ç³–è¿½è¹¤è¨˜éŒ„ç³»çµ±</h1>
                <p>è«‹ç™»å…¥ä»¥é–‹å§‹ä½¿ç”¨</p>
            </div>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="showTab('login')">ç™»å…¥</button>
                <button class="tab-btn" onclick="showTab('register')">è¨»å†Š</button>
            </div>

            <!-- ç™»å…¥è¡¨å–® -->
            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginEmail">é›»å­éƒµä»¶</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">å¯†ç¢¼</label>
                    <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
                </div>
                <button type="button" class="btn-primary" onclick="loginUser()">ç™»å…¥</button>
                <p class="error-message" id="loginError"></p>
            </div>

            <!-- è¨»å†Šè¡¨å–® -->
            <div id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="registerEmail">é›»å­éƒµä»¶</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">å¯†ç¢¼</label>
                    <input type="password" id="registerPassword" placeholder="è‡³å°‘6å€‹å­—å…ƒ" required>
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">ç¢ºèªå¯†ç¢¼</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼" required>
                </div>
                <button type="button" class="btn-primary" onclick="registerUser()">è¨»å†Š</button>
                <p class="error-message" id="registerError"></p>
            </div>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ -->
    <div id="mainApp" class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ©¸ è¡€ç³–è¿½è¹¤è¨˜éŒ„ç³»çµ±</h1>
            <button class="btn-logout" onclick="logoutUser()">ç™»å‡º</button>
        </div>

        <div class="card">
            <h2>ğŸ“ è¨˜éŒ„è¡€ç³–æ•¸å€¼</h2>
            
            <div class="unit-toggle">
                <button class="unit-btn active" onclick="switchUnit('mmol/L')">mmol/L</button>
                <button class="unit-btn" onclick="switchUnit('mg/dL')">mg/dL</button>
            </div>

            <form id="glucoseForm" onsubmit="return false;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="time">æ™‚é–“</label>
                        <input type="time" id="time" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="value">è¡€ç³–å€¼ (<span id="currentUnit">mmol/L</span>)</label>
                    <input type="number" id="value" step="0.1" min="0" placeholder="è«‹è¼¸å…¥è¡€ç³–æ•¸å€¼" required>
                </div>

                <div class="form-group">
                    <label>æ¸¬é‡æ™‚é–“é»</label>
                    <div class="timing-buttons">
                        <button type="button" class="timing-btn" data-timing="fasting">ç©ºè…¹</button>
                        <button type="button" class="timing-btn" data-timing="before_meal">é£¯å‰</button>
                        <button type="button" class="timing-btn" data-timing="after_meal">é£¯å¾Œ2å°æ™‚</button>
                        <button type="button" class="timing-btn" data-timing="bedtime">ç¡å‰</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea id="notes" placeholder="è¨˜éŒ„é£²é£Ÿã€é‹å‹•æˆ–å…¶ä»–å½±éŸ¿å› ç´ ..."></textarea>
                </div>

                <button type="button" class="btn-primary" onclick="saveRecord()">ğŸ’¾ å„²å­˜è¨˜éŒ„</button>
            </form>
        </div>

        <div class="card">
            <h2>ğŸ“Š çµ±è¨ˆæ‘˜è¦</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgValue">-</div>
                    <div class="stat-label">å¹³å‡å€¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxValue">-</div>
                    <div class="stat-label">æœ€é«˜å€¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="minValue">-</div>
                    <div class="stat-label">æœ€ä½å€¼</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ è¨˜éŒ„åˆ—è¡¨</h2>
            <div id="recordsList" class="records-list">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>å°šç„¡è¨˜éŒ„ï¼Œé–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†è¡€ç³–æ•¸å€¼å§ï¼</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ‘¤ äººå“¡ç®¡ç†</h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn-secondary" onclick="showSettings()">âœï¸ ç®¡ç†äººå“¡</button>
                <button class="btn-secondary" onclick="generateReport()">ğŸ“„ ç”Ÿæˆå ±è¡¨</button>
            </div>
            <div id="userInfoDisplay" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                <p style="margin-bottom: 8px;"><strong>ğŸ‘¤ å§“åï¼š</strong><span id="displayName">-</span></p>
                <p style="margin-bottom: 8px;"><strong>ğŸ‚ å‡ºç”Ÿæ—¥æœŸï¼š</strong><span id="displayBirthDate">-</span> (<span id="displayAge">-</span>)</p>
                <p><strong>âš§ æ€§åˆ¥ï¼š</strong><span id="displayGender">-</span></p>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2026 Billion Studio | å¥åº·ç®¡ç†å·¥å…·ç³»åˆ—</p>
        </div>
    </div>

    <!-- è¨­å®š Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ‘¤ äººå“¡ç®¡ç†</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            <div class="form-group">
                <label for="userName">å§“å</label>
                <input type="text" id="userName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>
            <div class="form-group">
                <label for="userGender">æ€§åˆ¥</label>
                <select id="userGender">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="male">ç”· Male</option>
                    <option value="female">å¥³ Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" id="birthDate">
            </div>
            <div class="form-group">
                <label>å¹´é½¡</label>
                <input type="text" id="userAge" readonly placeholder="å°‡è‡ªå‹•è¨ˆç®—">
            </div>
            <button class="btn-primary" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <!-- å ±è¡¨ Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ğŸ“„ è¡€ç³–è¿½è¹¤å ±è¡¨</h2>
                <button class="close-btn" onclick="closeReport()">&times;</button>
            </div>
            <div id="reportContent"></div>
            <button class="btn-primary" onclick="downloadPDF()">ğŸ“¥ ä¸‹è¼‰ PDF</button>
        </div>
    </div>

    <!-- jsPDF åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA156hYpzmkKOkwfruueSAOwPsBiZdEyFg",
            authDomain: "glucose-tracker-1ce2d.firebaseapp.com",
            projectId: "glucose-tracker-1ce2d",
            storageBucket: "glucose-tracker-1ce2d.firebasestorage.app",
            messagingSenderId: "156879055080",
            appId: "1:156879055080:web:23495e17dd2def5765c15d"
        };

        // åˆå§‹åŒ– Firebase
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
            alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        }

        let currentUser = null;
        let currentUnit = 'mmol/L';
        let selectedTiming = null;
        let userProfile = null;

        // ç›£è½èªè­‰ç‹€æ…‹
        auth.onAuthStateChanged((user) => {
            console.log('èªè­‰ç‹€æ…‹è®Šæ›´:', user ? 'å·²ç™»å…¥' : 'æœªç™»å…¥');
            if (user) {
                currentUser = user;
                loadUserProfile();
                showMainApp();
            } else {
                currentUser = null;
                showLoginPage();
            }
        });

        // è¼‰å…¥ç”¨æˆ¶è¨­å®š
        async function loadUserProfile() {
            try {
                const doc = await db.collection('userProfiles').doc(currentUser.uid).get();
                if (doc.exists) {
                    userProfile = doc.data();
                    console.log('ç”¨æˆ¶è¨­å®šå·²è¼‰å…¥:', userProfile);
                    displayUserInfo();
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è¨­å®šå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        function displayUserInfo() {
            if (userProfile) {
                const birth = new Date(userProfile.birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }

                document.getElementById('displayName').textContent = userProfile.name;
                document.getElementById('displayBirthDate').textContent = userProfile.birthDate;
                document.getElementById('displayAge').textContent = age + 'æ­²';
                document.getElementById('displayGender').textContent = userProfile.gender === 'male' ? 'ç”· Male' : 'å¥³ Female';
                document.getElementById('userInfoDisplay').style.display = 'block';
            }
        }

        // é¡¯ç¤ºè¨­å®š Modal
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            if (userProfile) {
                document.getElementById('userName').value = userProfile.name || '';
                document.getElementById('userGender').value = userProfile.gender || '';
                document.getElementById('birthDate').value = userProfile.birthDate || '';
                calculateAge();
            }
        }

        // é—œé–‰è¨­å®š Modal
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // è¨ˆç®—å¹´é½¡
        function calculateAge() {
            const birthDate = document.getElementById('birthDate').value;
            if (birthDate) {
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                document.getElementById('userAge').value = age + ' æ­²';
            }
        }

        // ç›£è½å‡ºç”Ÿæ—¥æœŸè®ŠåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const birthDateInput = document.getElementById('birthDate');
            if (birthDateInput) {
                birthDateInput.addEventListener('change', calculateAge);
            }
        });

        // å„²å­˜ç”¨æˆ¶è¨­å®š
        async function saveSettings() {
            const name = document.getElementById('userName').value.trim();
            const gender = document.getElementById('userGender').value;
            const birthDate = document.getElementById('birthDate').value;

            if (!name || !gender || !birthDate) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            const profile = {
                name: name,
                gender: gender,
                birthDate: birthDate,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('userProfiles').doc(currentUser.uid).set(profile);
                userProfile = profile;
                displayUserInfo();
                alert('âœ… è¨­å®šå·²å„²å­˜ï¼');
                closeSettings();
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                alert('âŒ å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // ç”Ÿæˆå ±è¡¨
        async function generateReport() {
            if (!userProfile) {
                alert('è«‹å…ˆè¨­å®šæ‚¨çš„å€‹äººè³‡æ–™');
                showSettings();
                return;
            }

            try {
                const snapshot = await db.collection('glucoseRecords')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });

                if (records.length === 0) {
                    alert('å°šç„¡è¨˜éŒ„å¯ç”Ÿæˆå ±è¡¨');
                    return;
                }

                displayReport(records);
                document.getElementById('reportModal').style.display = 'flex';
            } catch (error) {
                console.error('ç”Ÿæˆå ±è¡¨å¤±æ•—:', error);
                alert('ç”Ÿæˆå ±è¡¨å¤±æ•—ï¼š' + error.message);
            }
        }

        // é¡¯ç¤ºå ±è¡¨
        function displayReport(records) {
            const reportContent = document.getElementById('reportContent');
            
            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalRecords = records.length;
            const values = records.map(r => convertUnit(r.value, r.unit, 'mmol/L'));
            const avgValue = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
            const maxValue = Math.max(...values).toFixed(1);
            const minValue = Math.min(...values).toFixed(1);

            // æŒ‰æ™‚é–“é»åˆ†é¡
            const fastingRecords = records.filter(r => r.timing === 'fasting');
            const afterMealRecords = records.filter(r => r.timing === 'after_meal');

            // è¨ˆç®—æ­£å¸¸/åé«˜/åä½æ¯”ä¾‹
            let normalCount = 0, highCount = 0, lowCount = 0;
            records.forEach(record => {
                const mmolValue = convertUnit(record.value, record.unit, 'mmol/L');
                const status = getGlucoseStatus(mmolValue, 'mmol/L', record.timing);
                if (status === 'normal') normalCount++;
                else if (status === 'high') highCount++;
                else if (status === 'low') lowCount++;
            });

            const normalPercent = ((normalCount / totalRecords) * 100).toFixed(0);
            const highPercent = ((highCount / totalRecords) * 100).toFixed(0);
            const lowPercent = ((lowCount / totalRecords) * 100).toFixed(0);

            // è¨ˆç®—å¹´é½¡
            const birth = new Date(userProfile.birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            // ç”Ÿæˆå ±è¡¨ HTML
            reportContent.innerHTML = `
                <div class="report-section">
                    <h3>ğŸ“‹ åŸºæœ¬è³‡æ–™</h3>
                    <p><strong>å§“åï¼š</strong>${userProfile.name}</p>
                    <p><strong>æ€§åˆ¥ï¼š</strong>${userProfile.gender === 'male' ? 'ç”· Male' : 'å¥³ Female'}</p>
                    <p><strong>å¹´é½¡ï¼š</strong>${age} æ­²</p>
                    <p><strong>å ±è¡¨æ—¥æœŸï¼š</strong>${today.toLocaleDateString('zh-TW')}</p>
                    <p><strong>è¨˜éŒ„æœŸé–“ï¼š</strong>${records[records.length-1].date} è‡³ ${records[0].date}</p>
                </div>

                <div class="report-section">
                    <h3>ğŸ“Š æ•´é«”çµ±è¨ˆ</h3>
                    <div class="report-stats">
                        <div class="report-stat-item">
                            <div class="report-stat-value">${totalRecords}</div>
                            <div class="report-stat-label">ç¸½è¨˜éŒ„æ•¸</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${avgValue}</div>
                            <div class="report-stat-label">å¹³å‡è¡€ç³– (mmol/L)</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${maxValue}</div>
                            <div class="report-stat-label">æœ€é«˜è¡€ç³– (mmol/L)</div>
                        </div>
                        <div class="report-stat-item">
                            <div class="report-stat-value">${minValue}</div>
                            <div class="report-stat-label">æœ€ä½è¡€ç³– (mmol/L)</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>ğŸ¯ è¡€ç³–æ§åˆ¶ç‹€æ³</h3>
                    <p style="margin-bottom: 15px;">
                        <span class="status-indicator status-normal">æ­£å¸¸ ${normalCount} æ¬¡ (${normalPercent}%)</span>
                        <span class="status-indicator status-high">åé«˜ ${highCount} æ¬¡ (${highPercent}%)</span>
                        <span class="status-indicator status-low">åä½ ${lowCount} æ¬¡ (${lowPercent}%)</span>
                    </p>
                    <div class="report-chart">
                        <div class="chart-bar">
                            <div class="chart-label">æ­£å¸¸</div>
                            <div class="chart-progress">
                                <div class="chart-fill" style="width: ${normalPercent}%; background: #27ae60;"></div>
                            </div>
                            <div class="chart-value">${normalPercent}%</div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-label">åé«˜</div>
                            <div class="chart-progress">
                                <div class="chart-fill" style="width: ${highPercent}%; background: #e74c3c;"></div>
                            </div>
                            <div class="chart-value">${highPercent}%</div>
                        </div>
                        <div class="chart-bar">
                            <div class="chart-label">åä½</div>
                            <div class="chart-progress">
                                <div class="chart-fill" style="width: ${lowPercent}%; background: #f39c12;"></div>
                            </div>
                            <div class="chart-value">${lowPercent}%</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>ğŸ½ï¸ ç©ºè…¹è¡€ç³–åˆ†æ</h3>
                    ${fastingRecords.length > 0 ? `
                        <p><strong>è¨˜éŒ„æ¬¡æ•¸ï¼š</strong>${fastingRecords.length} æ¬¡</p>
                        <p><strong>å¹³å‡å€¼ï¼š</strong>${(fastingRecords.map(r => convertUnit(r.value, r.unit, 'mmol/L')).reduce((a,b) => a+b, 0) / fastingRecords.length).toFixed(1)} mmol/L</p>
                        <p><strong>æ­£å¸¸ç¯„åœï¼š</strong>4.0 - 6.0 mmol/L</p>
                    ` : '<p>æš«ç„¡ç©ºè…¹è¡€ç³–è¨˜éŒ„</p>'}
                </div>

                <div class="report-section">
                    <h3>ğŸ´ é£¯å¾Œè¡€ç³–åˆ†æ</h3>
                    ${afterMealRecords.length > 0 ? `
                        <p><strong>è¨˜éŒ„æ¬¡æ•¸ï¼š</strong>${afterMealRecords.length} æ¬¡</p>
                        <p><strong>å¹³å‡å€¼ï¼š</strong>${(afterMealRecords.map(r => convertUnit(r.value, r.unit, 'mmol/L')).reduce((a,b) => a+b, 0) / afterMealRecords.length).toFixed(1)} mmol/L</p>
                        <p><strong>æ­£å¸¸ç¯„åœï¼š</strong>< 7.8 mmol/L</p>
                    ` : '<p>æš«ç„¡é£¯å¾Œè¡€ç³–è¨˜éŒ„</p>'}
                </div>

                <div class="report-section">
                    <h3>ğŸ’¡ å¥åº·å»ºè­°</h3>
                    ${highPercent > 30 ? '<p>âš ï¸ åé«˜æ¯”ä¾‹è¼ƒé«˜ï¼Œå»ºè­°è«®è©¢é†«ç”Ÿï¼Œèª¿æ•´é£²é£Ÿå’Œé‹å‹•è¨ˆåŠƒã€‚</p>' : ''}
                    ${normalPercent >= 70 ? '<p>âœ… è¡€ç³–æ§åˆ¶è‰¯å¥½ï¼Œè«‹ç¹¼çºŒä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼ã€‚</p>' : ''}
                    ${lowPercent > 20 ? '<p>âš ï¸ åä½æ¯”ä¾‹è¼ƒé«˜ï¼Œæ³¨æ„æ˜¯å¦æœ‰ä½è¡€ç³–ç—‡ç‹€ï¼Œå»ºè­°è«®è©¢é†«ç”Ÿã€‚</p>' : ''}
                    <p>ğŸ“Œ å®šæœŸç›£æ¸¬è¡€ç³–ï¼Œä¿æŒå¥åº·é£²é£Ÿå’Œé©åº¦é‹å‹•ã€‚</p>
                    <p>ğŸ“Œ å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹è«®è©¢æ‚¨çš„é†«ç™‚ä¿å¥æä¾›è€…ã€‚</p>
                </div>

                <div class="report-section">
                    <h3>ğŸ“ æœ€è¿‘è¨˜éŒ„</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${records.slice(0, 10).map(record => {
                            const mmolValue = convertUnit(record.value, record.unit, 'mmol/L');
                            const status = getGlucoseStatus(mmolValue, 'mmol/L', record.timing);
                            const statusClass = status === 'normal' ? 'status-normal' : status === 'high' ? 'status-high' : 'status-low';
                            const statusText = status === 'normal' ? 'æ­£å¸¸' : status === 'high' ? 'åé«˜' : 'åä½';
                            return `
                                <p style="margin-bottom: 8px;">
                                    <strong>${record.date} ${record.time}</strong> - 
                                    ${getTimingText(record.timing)}: 
                                    ${mmolValue.toFixed(1)} mmol/L 
                                    <span class="status-indicator ${statusClass}">${statusText}</span>
                                </p>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // é—œé–‰å ±è¡¨ Modal
        function closeReport() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // ä¸‹è¼‰ PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const reportContent = document.getElementById('reportContent');

            try {
                // ä½¿ç”¨ html2canvas å°‡ HTML è½‰æ›ç‚ºåœ–ç‰‡
                const canvas = await html2canvas(reportContent, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 å¯¬åº¦
                const pageHeight = 297; // A4 é«˜åº¦
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // æ·»åŠ ç¬¬ä¸€é 
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // å¦‚æœå…§å®¹è¶…éä¸€é ï¼Œæ·»åŠ æ›´å¤šé é¢
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `è¡€ç³–è¿½è¹¤å ±è¡¨_${userProfile.name}_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.pdf`;
                pdf.save(fileName);
            } catch (error) {
                console.error('ç”Ÿæˆ PDF å¤±æ•—:', error);
                alert('ç”Ÿæˆ PDF å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // é¡¯ç¤ºç™»å…¥é é¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // é¡¯ç¤ºä¸»æ‡‰ç”¨
        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            initializeApp();
        }

        // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨™ç±¤
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tab === 'login') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        // è¨»å†Šç”¨æˆ¶
        async function registerUser() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerPasswordConfirm').value;
            const errorElement = document.getElementById('registerError');

            errorElement.textContent = '';

            if (!email || !password || !confirmPassword) {
                errorElement.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                return;
            }

            if (password.length < 6) {
                errorElement.textContent = 'å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ';
                return;
            }

            if (password !== confirmPassword) {
                errorElement.textContent = 'å¯†ç¢¼ä¸ä¸€è‡´';
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                alert('âœ… è¨»å†ŠæˆåŠŸï¼');
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                if (error.code === 'auth/email-already-in-use') {
                    errorElement.textContent = 'æ­¤é›»å­éƒµä»¶å·²è¢«ä½¿ç”¨';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º';
                } else {
                    errorElement.textContent = 'è¨»å†Šå¤±æ•—ï¼š' + error.message;
                }
            }
        }

        // ç™»å…¥ç”¨æˆ¶
        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');

            errorElement.textContent = '';

            if (!email || !password) {
                errorElement.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½';
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorElement.textContent = 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤';
                } else if (error.code === 'auth/invalid-email') {
                    errorElement.textContent = 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º';
                } else if (error.code === 'auth/invalid-credential') {
                    errorElement.textContent = 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤';
                } else {
                    errorElement.textContent = 'ç™»å…¥å¤±æ•—ï¼š' + error.message;
                }
            }
        }

        // ç™»å‡ºç”¨æˆ¶
        async function logoutUser() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('ç™»å‡ºéŒ¯èª¤:', error);
                    alert('ç™»å‡ºå¤±æ•—');
                }
            }
        }

        // åˆå§‹åŒ–ä¸»æ‡‰ç”¨
        function initializeApp() {
            // è¨­å®šä»Šå¤©æ—¥æœŸå’Œç•¶å‰æ™‚é–“
            const now = new Date();
            const dateInput = document.getElementById('date');
            const timeInput = document.getElementById('time');
            
            if (dateInput && timeInput) {
                dateInput.valueAsDate = now;
                timeInput.value = now.toTimeString().slice(0, 5);
            }

            // ç¶å®šæ™‚é–“é»æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.timing-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedTiming = this.dataset.timing;
                };
            });

            // è¼‰å…¥è¨˜éŒ„
            loadRecords();
            updateStats();
        }

        // åˆ‡æ›å–®ä½
        function switchUnit(unit) {
            currentUnit = unit;
            document.getElementById('currentUnit').textContent = unit;
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === unit);
            });
            
            loadRecords();
            updateStats();
        }

        // å–®ä½è½‰æ›
        function convertUnit(value, fromUnit, toUnit) {
            if (fromUnit === toUnit) return value;
            if (fromUnit === 'mmol/L' && toUnit === 'mg/dL') {
                return value * 18;
            }
            if (fromUnit === 'mg/dL' && toUnit === 'mmol/L') {
                return value / 18;
            }
            return value;
        }

        // å„²å­˜è¨˜éŒ„åˆ° Firebase
        async function saveRecord() {
            if (!selectedTiming) {
                alert('è«‹é¸æ“‡æ¸¬é‡æ™‚é–“é»');
                return;
            }

            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            const valueInput = document.getElementById('value').value;
            if (!valueInput) {
                alert('è«‹è¼¸å…¥è¡€ç³–æ•¸å€¼');
                return;
            }

            const record = {
                userId: currentUser.uid,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                value: parseFloat(valueInput),
                unit: currentUnit,
                timing: selectedTiming,
                notes: document.getElementById('notes').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                console.log('æº–å‚™å„²å­˜è¨˜éŒ„:', record);
                await db.collection('glucoseRecords').add(record);
                console.log('è¨˜éŒ„å„²å­˜æˆåŠŸ');

                // é‡ç½®è¡¨å–®
                document.getElementById('value').value = '';
                document.getElementById('notes').value = '';
                document.querySelectorAll('.timing-btn').forEach(b => b.classList.remove('active'));
                selectedTiming = null;
                
                // é‡æ–°è¨­å®šæ—¥æœŸæ™‚é–“
                const now = new Date();
                document.getElementById('date').valueAsDate = now;
                document.getElementById('time').value = now.toTimeString().slice(0, 5);

                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                loadRecords();
                updateStats();

                alert('âœ… è¨˜éŒ„å·²æˆåŠŸå„²å­˜ï¼');
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                alert('âŒ å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // å¾ Firebase è¼‰å…¥è¨˜éŒ„
        function loadRecords() {
            if (!currentUser) {
                console.log('æœªç™»å…¥ï¼Œç„¡æ³•è¼‰å…¥è¨˜éŒ„');
                return;
            }

            console.log('é–‹å§‹è¼‰å…¥è¨˜éŒ„... ç”¨æˆ¶ID:', currentUser.uid);
            
            // ç›´æ¥è¼‰å…¥æ‰€æœ‰è¨˜éŒ„ï¼Œä¸ä½¿ç”¨ orderByï¼Œé¿å…ç´¢å¼•å•é¡Œ
            db.collection('glucoseRecords')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('æ‰¾åˆ°è¨˜éŒ„:', data);
                        records.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    console.log('ç¸½å…±è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                    
                    // æ‰‹å‹•æ’åºï¼šæŒ‰æ—¥æœŸå’Œæ™‚é–“é™åº
                    records.sort((a, b) => {
                        const dateTimeA = new Date(a.date + ' ' + a.time);
                        const dateTimeB = new Date(b.date + ' ' + b.time);
                        return dateTimeB - dateTimeA; // é™åºï¼šæœ€æ–°çš„åœ¨å‰
                    });
                    
                    console.log('æ’åºå¾Œçš„è¨˜éŒ„:', records);
                    displayRecords(records);
                })
                .catch((error) => {
                    console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
                    console.error('éŒ¯èª¤ä»£ç¢¼:', error.code);
                    console.error('éŒ¯èª¤è¨Šæ¯:', error.message);
                    
                    // é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯
                    const container = document.getElementById('recordsList');
                    container.innerHTML = `
                        <div class="empty-state">
                            <p style="color: #e74c3c; font-weight: 600;">âš ï¸ è¼‰å…¥å¤±æ•—</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                éŒ¯èª¤ï¼š${error.message}
                            </p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                è«‹æª¢æŸ¥ Firebase å®‰å…¨è¦å‰‡è¨­å®š
                            </p>
                        </div>
                    `;
                });
        }

        // é¡¯ç¤ºè¨˜éŒ„
        function displayRecords(records) {
            const container = document.getElementById('recordsList');

            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>å°šç„¡è¨˜éŒ„ï¼Œé–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€ç­†è¡€ç³–æ•¸å€¼å§ï¼</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = records.map(record => {
                const displayValue = convertUnit(record.value, record.unit, currentUnit);
                const status = getGlucoseStatus(displayValue, currentUnit, record.timing);
                const timingText = getTimingText(record.timing);

                return `
                    <div class="record-item ${status}">
                        <div class="record-info">
                            <div class="record-value">
                                ${displayValue.toFixed(1)} 
                                <span class="unit">${currentUnit}</span>
                            </div>
                            <div class="record-details">
                                <span class="record-timing">${timingText}</span>
                                ğŸ“… ${record.date} ${record.time}
                                ${record.notes ? `<br>ğŸ“ ${record.notes}` : ''}
                            </div>
                        </div>
                        <div class="record-actions">
                            <button class="btn-delete" onclick="deleteRecord('${record.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ¤æ–·è¡€ç³–ç‹€æ…‹
        function getGlucoseStatus(value, unit, timing) {
            let mmolValue = unit === 'mmol/L' ? value : value / 18;

            if (timing === 'fasting') {
                if (mmolValue < 4.0) return 'low';
                if (mmolValue >= 4.0 && mmolValue <= 6.0) return 'normal';
                return 'high';
            } else if (timing === 'after_meal') {
                if (mmolValue < 4.0) return 'low';
                if (mmolValue <= 7.8) return 'normal';
                return 'high';
            } else {
                if (mmolValue < 4.0) return 'low';
                if (mmolValue <= 7.0) return 'normal';
                return 'high';
            }
        }

        // å–å¾—æ™‚é–“é»æ–‡å­—
        function getTimingText(timing) {
            const texts = {
                'fasting': 'ç©ºè…¹',
                'before_meal': 'é£¯å‰',
                'after_meal': 'é£¯å¾Œ2å°æ™‚',
                'bedtime': 'ç¡å‰'
            };
            return texts[timing] || timing;
        }

        // åˆªé™¤è¨˜éŒ„
        async function deleteRecord(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;

            try {
                await db.collection('glucoseRecords').doc(id).delete();
                loadRecords();
                updateStats();
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            if (!currentUser) return;

            db.collection('glucoseRecords')
                .where('userId', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push(doc.data());
                    });

                    console.log('çµ±è¨ˆæ•¸æ“šè¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');

                    if (records.length === 0) {
                        document.getElementById('avgValue').textContent = '-';
                        document.getElementById('maxValue').textContent = '-';
                        document.getElementById('minValue').textContent = '-';
                        return;
                    }

                    const values = records.map(r => convertUnit(r.value, r.unit, currentUnit));
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const max = Math.max(...values);
                    const min = Math.min(...values);

                    document.getElementById('avgValue').textContent = avg.toFixed(1);
                    document.getElementById('maxValue').textContent = max.toFixed(1);
                    document.getElementById('minValue').textContent = min.toFixed(1);
                })
                .catch((error) => {
                    console.error('çµ±è¨ˆè¼‰å…¥å¤±æ•—:', error);
                });
        }

        // Enter éµæ”¯æ´
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const loginPage = document.getElementById('loginPage');
                if (loginPage && loginPage.style.display !== 'none') {
                    const loginForm = document.getElementById('loginForm');
                    const registerForm = document.getElementById('registerForm');
                    
                    if (loginForm.style.display !== 'none') {
                        loginUser();
                    } else if (registerForm.style.display !== 'none') {
                        registerUser();
                    }
                }
            }
        });
    </script>
</body>
</html>
